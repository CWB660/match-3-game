<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üêë Áæä‰∫Ü‰∏™Áæä</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            color: #2c3e50;
            overflow: hidden;
            position: fixed;
            width: 100%;
        }
        
        .game-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: min(2vw, 24px);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            margin: 0;
            padding: 10px;
            width: 100%;
            height: 100%;
            position: relative;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }
        
        .game-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #ffeaa7);
            border-radius: 24px 24px 0 0;
        }
        
        canvas {
            border: none;
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            cursor: pointer;
            border-radius: min(2vw, 16px);
            box-shadow: 
                0 10px 25px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
        }
        
        canvas:hover {
            box-shadow: 
                0 15px 35px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }
        
        .canvas-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 0;
            padding: min(1vh, 10px) 0;
            height: 100%;
        }
        
        .game-title {
            text-align: center;
            margin: 0 0 min(1vh, 10px) 0;
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .game-subtitle {
            text-align: center;
            margin: 0 0 min(1.5vh, 15px) 0;
            font-size: clamp(0.9rem, 2.5vw, 1.1rem);
            color: #64748b;
            font-weight: 500;
        }
        
        .info {
            font-size: 0.8rem;
            color: #475569;
            font-weight: 500;
        }
        
        .slot-container {
            text-align: center;
            background: linear-gradient(145deg, #f8fafc, #e2e8f0);
            border-radius: min(1.5vw, 15px);
            padding: min(1vh, 12px) min(1.5vw, 15px);
            box-shadow: 
                0 6px 20px rgba(0, 0, 0, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            flex-shrink: 0;
        }
        
        .slot-title {
            font-size: 1rem;
            font-weight: 600;
            color: #334155;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .slot-title::before,
        .slot-title::after {
            content: '';
            width: 40px;
            height: 2px;
            background: linear-gradient(90deg, transparent, #94a3b8, transparent);
        }
        
        .slots {
            display: flex;
            justify-content: center;
            gap: min(1vw, 8px);
            margin: min(1vh, 10px) 0;
            min-height: clamp(45px, 8vh, 60px);
            background: rgba(255, 255, 255, 0.6);
            border-radius: min(1.5vw, 12px);
            padding: min(1vh, 10px);
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
            flex-wrap: wrap;
        }
        
        .slots:has(.slot-card) {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.05);
        }
        
        .slot-card {
            width: 40px;
            height: 40px;
            border: 2px solid #10b981;
            border-radius: min(1vw, 8px);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(16px, 4vw, 24px);
            background: linear-gradient(145deg, #10b981, #059669);
            color: white;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            box-shadow: 
                0 3px 12px rgba(16, 185, 129, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        .slot-card:empty {
            background: transparent;
            border: 2px dashed #cbd5e1;
            box-shadow: none;
        }
        
        .slot-card.removing {
            animation: slotRemove 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes slotRemove {
            0% { 
                transform: scale(1) rotate(0deg); 
                opacity: 1; 
            }
            30% { 
                transform: scale(1.15) rotate(5deg); 
                background: linear-gradient(145deg, #f59e0b, #d97706);
                box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
            }
            100% { 
                transform: scale(0) rotate(180deg); 
                opacity: 0; 
            }
        }
        
        .slot-card.adding {
            animation: slotAdd 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        @keyframes slotAdd {
            0% { 
                transform: scale(0) translateY(-80px) rotate(-180deg); 
                opacity: 0; 
            }
            50% { 
                transform: scale(1.2) translateY(-20px) rotate(-90deg); 
            }
            100% { 
                transform: scale(1) translateY(0) rotate(0deg); 
                opacity: 1; 
            }
        }
        
        .slot-card.warning {
            border-color: #f59e0b;
            background: linear-gradient(145deg, #f59e0b, #d97706);
            animation: pulse 1.5s ease-in-out infinite;
            box-shadow: 
                0 4px 15px rgba(245, 158, 11, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        @keyframes pulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 8px 25px rgba(245, 158, 11, 0.6);
            }
        }
        
        .controls {
            margin: min(2vh, 20px) 0;
            display: flex;
            gap: min(2vw, 15px);
            justify-content: center;
            flex-wrap: wrap;
            flex-shrink: 0;
        }
        
        .btn {
            padding: clamp(10px, 2vh, 14px) clamp(20px, 4vw, 28px);
            font-size: clamp(0.8rem, 2.5vw, 1rem);
            border: none;
            border-radius: min(1.5vw, 12px);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            font-family: inherit;
            position: relative;
            overflow: hidden;
            min-width: clamp(100px, 20vw, 120px);
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }
        
        .btn-purple {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }
        
        .btn-purple:hover {
            background: linear-gradient(135deg, #7c3aed, #6d28d9);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
        }
        
        .level-info {
            margin: 0;
            display: flex;
            gap: min(1vw, 10px);
            justify-content: flex-start;
            font-size: clamp(0.7rem, 2vw, 0.85rem);
            font-weight: 600;
            flex-wrap: wrap;
            flex-shrink: 0;
        }
        
        .level-info .info {
            background: linear-gradient(135deg, #e0f2fe, #b3e5fc);
            padding: clamp(4px, 1vh, 8px) clamp(8px, 2vw, 12px);
            border-radius: min(2vw, 15px);
            border: 1px solid #0ea5e9;
            color: #0c4a6e;
            box-shadow: 0 2px 8px rgba(14, 165, 233, 0.2);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .level-info .info:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(14, 165, 233, 0.3);
        }
        
        @keyframes dangerPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1); }
        }
        
        .top-bar {
            width: 100%;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            padding: 0 20px;
        }
        
        .top-bar .btn {
            font-size: 0.8rem;
            padding: 8px 16px;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.4s ease-out;
        }
        
        @keyframes fadeIn {
            from { 
                opacity: 0;
                backdrop-filter: blur(0px);
            }
            to { 
                opacity: 1;
                backdrop-filter: blur(5px);
            }
        }
        
        .modal-content {
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            padding: 40px 50px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.25),
                0 0 0 1px rgba(255, 255, 255, 0.05);
            animation: modalSlideIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            min-width: 400px;
            max-width: 90vw;
            position: relative;
            overflow: hidden;
        }
        
        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1);
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(-50px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .modal-content h2 {
            margin-top: 0;
            color: #1e293b;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 15px;
        }
        
        .modal-content p {
            font-size: 1.1rem;
            color: #64748b;
            margin: 20px 0 30px;
            line-height: 1.6;
        }
        
        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .game-status {
            text-align: center;
            font-size: clamp(0.9rem, 2.5vw, 1.1rem);
            font-weight: 500;
            padding: clamp(10px, 2vh, 15px) clamp(20px, 4vw, 25px);
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border-radius: min(1.5vw, 12px);
            border: 1px solid #0ea5e9;
            color: #0c4a6e;
            margin: min(2vh, 20px) 0;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        
        /* ÂìçÂ∫îÂºèËÆæËÆ°‰ºòÂåñ */
        @media (max-width: 768px) {
            .slots {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .modal-content {
                min-width: 85vw;
                max-width: 400px;
                padding: clamp(20px, 4vw, 30px);
            }
            
            .modal-content h2 {
                font-size: clamp(1.25rem, 5vw, 1.75rem);
            }
            
            .modal-buttons {
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }
        }
        
        @media (max-width: 480px) {
            
        }
        
        @media (orientation: landscape) and (max-height: 600px) {
            .game-container {
                overflow-y: auto;
            }
            
            .slot-container {
                margin: 0.5vh 0;
            }
            
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="top-bar">
            <div class="level-info">
                <div class="info">Á¨¨ <span id="currentLevel">1</span> ÂÖ≥</div>
                <div class="info">ÈöæÂ∫¶Ôºö<span id="difficulty">ÁÆÄÂçï</span></div>
            </div>
            <div style="display: flex; gap: 10px;">
                <!-- <button id="debugBtn" class="btn btn-purple" onclick="window.game.debugGameState()">Ë∞ÉËØïÊ£ÄÊü•</button> -->
            <button id="restartBtn" class="btn btn-danger" onclick="window.game.restart()">ÈáçÊñ∞ÂºÄÂßã</button>
            </div>
        </div>

        <div class="canvas-container">
            <canvas id="gameCanvas"></canvas>
        </div>
        
        <!-- 8ÊßΩ‰ΩçÂàóË°® -->
        <div class="slot-container">
            <div class="slots" id="slotContainer">
                <!-- ÊßΩ‰ΩçÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
            </div>
        </div>

    </div>

    <div id="modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2 id="modalTitle"></h2>
            <p id="modalMessage"></p>
            <div class="modal-buttons">
                <button id="modalNextLevelBtn" class="btn btn-primary" style="display: none;">‰∏ã‰∏ÄÂÖ≥</button>
                <button id="modalRestartBtn" class="btn btn-danger">ÈáçÊñ∞ÂºÄÂßã</button>
            </div>
        </div>
    </div>

    <script>
        class Card {
            constructor(x, y, layer, emoji, canvasSize) {
                this.x = x;
                this.y = y;
                this.layer = layer;
                this.emoji = emoji;
                this.visible = true;
                this.selected = false;
                this.isClickable = true;
                this.isBlocked = false;
                
                // Ê†πÊçÆcanvasÂ∞∫ÂØ∏Âä®ÊÄÅËÆ°ÁÆóÂç°ÁâåÂ§ßÂ∞è
                const baseSize = Math.min(canvasSize.width / 18, canvasSize.height / 12, 65);
                this.width = Math.max(30, baseSize);
                this.height = Math.max(30, baseSize);
            }

            draw(ctx) {
                if (!this.visible) return;

                ctx.save();
                
                // Âç°ÁâåÈò¥ÂΩ±
                ctx.shadowColor = 'rgba(0,0,0,0.3)';
                ctx.shadowBlur = 4;
                ctx.shadowOffsetX = 2;
                ctx.shadowOffsetY = 2;

                // Âç°ÁâåËÉåÊôØÔºöÁªü‰∏ÄÊµÖÈªÑËâ≤ÔºåÂè™ÊúâË¢´ÈÅÆÊå°ÁöÑÊâçÂèòÊöó
                if (this.selected) {
                    ctx.fillStyle = '#E8F5E8'; // ÈÄâ‰∏≠Áä∂ÊÄÅÔºöÊ∑°ÁªøËâ≤
                } else if (this.isBlocked) {
                    ctx.fillStyle = '#A5D6A7'; // Ë¢´ÈÅÆÊå°Áä∂ÊÄÅÔºöÊ∑°ÁªøËâ≤
                } else {
                    ctx.fillStyle = '#F8FFD1'; // Ê≠£Â∏∏Áä∂ÊÄÅÔºöÊµÖÈªÑËâ≤
                }
                
                // ÁªòÂà∂ÂúÜËßíÁü©ÂΩ¢
                const cardRadius = 8;
                ctx.beginPath();
                ctx.roundRect(this.x, this.y, this.width, this.height, cardRadius);
                ctx.fill();
                
                // Âç°ÁâåËæπÊ°ÜÔºöÁªü‰∏ÄÊöóÁªøËâ≤ËæπÊ°Ü
                if (this.selected) {
                    ctx.strokeStyle = '#1B5E20'; // ÈÄâ‰∏≠Áä∂ÊÄÅÔºöÂæàÊöóÁöÑÊ∑±ÁªøËâ≤ËæπÊ°Ü
                    ctx.lineWidth = 3;
                    ctx.shadowColor = 'rgba(27, 94, 32, 0.5)';
                    ctx.shadowBlur = 6;
                } else if (this.isBlocked) {
                    ctx.strokeStyle = '#2E7D32'; // Ë¢´ÈÅÆÊå°Áä∂ÊÄÅÔºöÊöóÁªøËâ≤ËæπÊ°Ü
                    ctx.lineWidth = 2;
                    ctx.shadowColor = 'rgba(46, 125, 50, 0.2)';
                    ctx.shadowBlur = 2;
                } else {
                    // Ê≠£Â∏∏Áä∂ÊÄÅÔºöÊ∑±ÁªøËâ≤ËæπÊ°Ü
                    ctx.strokeStyle = '#1B5E20';
                    ctx.lineWidth = 2;
                    ctx.shadowColor = 'rgba(27, 94, 32, 0.3)';
                    ctx.shadowBlur = 3;
                }
                
                // ÁªòÂà∂ÂúÜËßíËæπÊ°Ü
                ctx.beginPath();
                ctx.roundRect(this.x, this.y, this.width, this.height, cardRadius);
                ctx.stroke();
                
                // ÈáçÁΩÆÈò¥ÂΩ±ÊïàÊûúÔºåÈÅøÂÖçÂΩ±ÂìçÂêéÁª≠ÁªòÂà∂
                ctx.shadowColor = 'rgba(0,0,0,0.3)';
                ctx.shadowBlur = 4;
                ctx.shadowOffsetX = 2;
                ctx.shadowOffsetY = 2;

                // ÁªòÂà∂emojiÔºöÂè™ÊúâË¢´ÈÅÆÊå°ÁöÑÊâçÂèòÊöó
                const fontSize = Math.min(this.width * 0.5, this.height * 0.5, 32);
                ctx.font = `${fontSize}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                if (this.isBlocked) {
                    ctx.fillStyle = '#424242'; // Ë¢´ÈÅÆÊå°Áä∂ÊÄÅÔºöÂæàÊöóÁöÑÁÅ∞Ëâ≤
                } else {
                    ctx.fillStyle = '#FFFFFF'; // Ê≠£Â∏∏Áä∂ÊÄÅÔºöÁ∫ØÁôΩËâ≤
                }
                ctx.fillText(this.emoji, this.x + this.width/2, this.y + this.height/2);

                // Â±ÇÁ∫ßÊ†áËØÜÔºàË∞ÉËØïÁî®Ôºâ
                ctx.font = '10px Arial';
                ctx.fillStyle = '#666';
                ctx.fillText(this.layer.toString(), this.x + 5, this.y + 10);

                // ‰∏∫Ë¢´ÈÅÆÊå°ÁöÑÂç°ÁâåÊ∑ªÂä†ÂçäÈÄèÊòéË¶ÜÁõñÂ±ÇÔºåÂ¢ûÂº∫ÊöóÊ∑°ÊïàÊûú
                if (this.isBlocked) {
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
                    ctx.beginPath();
                    ctx.roundRect(this.x, this.y, this.width, this.height, cardRadius);
                    ctx.fill();
                }

                ctx.restore();
            }

  
            isPointInside(x, y) {
                return x >= this.x && x <= this.x + this.width &&
                       y >= this.y && y <= this.y + this.height;
            }
        }

        class Game {
            constructor(canvas) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.cards = [];
                this.slots = []; // ÊßΩ‰Ωç‰∏≠ÁöÑÂç°Áâå
                this.maxSlots = 8; // ÊúÄÂ§ö8‰∏™ÊßΩ‰Ωç
                this.currentLevel = 1;
                this.maxLevel = 10;
                this.emojis = ['üêë', 'üåü', 'üéà', 'üå∫', 'üçé', 'üöÄ', 'üåà', 'üéØ', 'ü¶ã', 'üå∏', 'üçä', 'ü¶Ñ', 'üê±', 'üê∂', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'üêØ', 'ü¶Å', 'üê∏'];
                this.isRemoving = false; // Èò≤Ê≠¢ÈáçÂ§çÁßªÈô§ÁöÑÊ†áÂøó
                
                // ÂÖ≥Âç°ÈÖçÁΩÆ
                this.levelConfigs = [
                    { level: 1, name: 'ÁÆÄÂçï', emojiTypes: 8, repetitionRate: 0.15, cardMultiplier: 0.8, shuffleRate: 0.2 },
                    { level: 2, name: 'ÁÆÄÂçï', emojiTypes: 9, repetitionRate: 0.18, cardMultiplier: 0.85, shuffleRate: 0.3 },
                    { level: 3, name: 'ÊôÆÈÄö', emojiTypes: 10, repetitionRate: 0.22, cardMultiplier: 0.9, shuffleRate: 0.4 },
                    { level: 4, name: 'ÊôÆÈÄö', emojiTypes: 11, repetitionRate: 0.25, cardMultiplier: 0.95, shuffleRate: 0.5 },
                    { level: 5, name: 'ÊôÆÈÄö', emojiTypes: 12, repetitionRate: 0.28, cardMultiplier: 1.0, shuffleRate: 0.6 },
                    { level: 6, name: 'Âõ∞Èöæ', emojiTypes: 13, repetitionRate: 0.32, cardMultiplier: 1.05, shuffleRate: 0.7 },
                    { level: 7, name: 'Âõ∞Èöæ', emojiTypes: 14, repetitionRate: 0.35, cardMultiplier: 1.1, shuffleRate: 0.8 },
                    { level: 8, name: 'Âõ∞Èöæ', emojiTypes: 15, repetitionRate: 0.38, cardMultiplier: 1.15, shuffleRate: 0.85 },
                    { level: 9, name: '‰∏ìÂÆ∂', emojiTypes: 16, repetitionRate: 0.42, cardMultiplier: 1.2, shuffleRate: 0.9 },
                    { level: 10, name: '‰∏ìÂÆ∂', emojiTypes: 18, repetitionRate: 0.45, cardMultiplier: 1.25, shuffleRate: 0.95 }
                ];
                this.modalListenersAdded = false;
                // ÂàùÂßãÂåñÊòæÁ§∫Â∞∫ÂØ∏ÈªòËÆ§ÂÄº
                this.canvasDisplayWidth = 800;
                this.canvasDisplayHeight = 600;
                this.setupCanvas();
                this.init();
                this.bindEvents();
                this.initSlots();
            }

            setupCanvas() {
                // Âä®ÊÄÅËÆæÁΩÆcanvasÂ∞∫ÂØ∏‰ª•ÈÄÇÂ∫îÁà∂ÂÆπÂô®
                const updateCanvasSize = () => {
                    const container = this.canvas.parentElement;
                    const containerRect = container.getBoundingClientRect();
                    
                    // Ëé∑ÂèñÁà∂ÂÆπÂô®ÁöÑÂÆûÈôÖÂèØÁî®Â∞∫ÂØ∏
                    const availableWidth = containerRect.width;
                    const availableHeight = containerRect.height;
                    
                    // Ëé∑ÂèñËÆæÂ§áÂÉèÁ¥†ÊØîÔºåÁ°Æ‰øùÊ∏ÖÊô∞Â∫¶
                    const devicePixelRatio = window.devicePixelRatio || 1;
                    
                    // ËÆæÁΩÆcanvasÁöÑÊòæÁ§∫Â∞∫ÂØ∏ÔºàCSSÂ∞∫ÂØ∏Ôºâ
                    this.canvas.style.width = availableWidth + 'px';
                    this.canvas.style.height = availableHeight + 'px';
                    
                    // ËÆæÁΩÆcanvasÁöÑÂÆûÈôÖÂ∞∫ÂØ∏ÔºàÁªòÂà∂Â∞∫ÂØ∏ÔºâÔºåËÄÉËôëËÆæÂ§áÂÉèÁ¥†ÊØî‰ª•‰øùÊåÅÊ∏ÖÊô∞Â∫¶
                    this.canvas.width = availableWidth * devicePixelRatio;
                    this.canvas.height = availableHeight * devicePixelRatio;
                    
                    // ÈáçÁΩÆÂèòÊç¢Áü©ÈòµÔºåÁÑ∂ÂêéÁº©ÊîæÁªòÂà∂‰∏ä‰∏ãÊñá‰ª•ÂåπÈÖçËÆæÂ§áÂÉèÁ¥†ÊØî
                    this.ctx.setTransform(1, 0, 0, 1, 0, 0);
                    this.ctx.scale(devicePixelRatio, devicePixelRatio);
                    
                    // Â≠òÂÇ®ÊòæÁ§∫Â∞∫ÂØ∏‰æõÂùêÊ†áËÆ°ÁÆó‰ΩøÁî®
                    this.canvasDisplayWidth = availableWidth;
                    this.canvasDisplayHeight = availableHeight;
                    
                    // ÈáçÊñ∞Â∏ÉÂ±ÄÂíåÁªòÂà∂Ê∏∏Êàè
                    if (this.cards && this.cards.length > 0) {
                        this.relayoutCards();
                        this.draw();
                    }
                };
                
                // Âª∂ËøüÊâßË°åÔºåÁ°Æ‰øùDOMÂÆåÂÖ®Ê∏≤Êüì
                setTimeout(updateCanvasSize, 10);
                window.addEventListener('resize', updateCanvasSize);
                window.addEventListener('orientationchange', () => {
                    setTimeout(updateCanvasSize, 100);
                });
            }

            init() {
                this.updateLevelDisplay();
                this.createCards();
                
                // ÂêØÂä®Êó∂Ëá™Âä®Ê£ÄÊü•Âç°ÁâåÁîüÊàêÊòØÂê¶Ê≠£Á°Æ
                setTimeout(() => {
                    this.performStartupValidation();
                }, 2000);
                
                this.updateClickableStatus();
                this.draw();
            }

            // ÂêØÂä®Êó∂È™åËØÅÂç°ÁâåÁîüÊàêÁöÑÊ≠£Á°ÆÊÄß
            performStartupValidation() {
                console.log('=== ÂêØÂä®Êó∂È™åËØÅÂç°ÁâåÁîüÊàê ===');
                let attempts = 0;
                const maxAttempts = 5;
                
                while (attempts < maxAttempts) {
                    attempts++;
                    console.log(`Á¨¨${attempts}Ê¨°È™åËØÅ`);
                    
                    // Ê£ÄÊü•ÂΩìÂâçÁîüÊàêÁöÑÂç°ÁâåÊòØÂê¶Ê≠£Á°Æ
                    const validationResult = this.validateCardGeneration();
                    
                    if (validationResult.isValid) {
                        console.log('‚úÖ È™åËØÅÈÄöËøáÔºÅÂç°ÁâåÁîüÊàêÊ≠£Á°ÆÔºåÊâÄÊúâemojiÈÉΩÊòØ3ÁöÑÂÄçÊï∞');
                        console.log('È™åËØÅÁªìÊûú:', validationResult);
                        return;
                    } else {
                        console.log(`‚ùå Á¨¨${attempts}Ê¨°È™åËØÅÂ§±Ë¥•:`, validationResult.errors);
                        console.log('ÈáçÊñ∞ÁîüÊàêÂç°Áâå...');
                        
                        // Ê∏ÖÁ©∫ÂΩìÂâçÂç°ÁâåÔºåÈáçÊñ∞ÁîüÊàê
                        this.cards = [];
                        this.createCards();
                    }
                }
                
                console.error(`‚ùå ÁªèËøá${maxAttempts}Ê¨°Â∞ùËØï‰ªçÊó†Ê≥ïÁîüÊàêÊ≠£Á°ÆÁöÑÂç°ÁâåÔºÅ‰ΩøÁî®Á¥ßÊÄ•‰øÆÂ§çÊ®°Âºè`);
                this.forceFixCardGeneration();
            }

            // È™åËØÅÂç°ÁâåÁîüÊàêÊòØÂê¶Ê≠£Á°Æ
            validateCardGeneration() {
                // ÁªüËÆ°ÊâÄÊúâÂç°Áâå‰∏≠ÊØèÁßçemojiÁöÑÊï∞Èáè
                const emojiCounts = {};
                this.cards.forEach(card => {
                    emojiCounts[card.emoji] = (emojiCounts[card.emoji] || 0) + 1;
                });
                
                const errors = [];
                let totalCards = 0;
                let validGroups = 0;
                
                // Ê£ÄÊü•ÊØèÁßçemojiÁöÑÊï∞ÈáèÊòØÂê¶ÊòØ3ÁöÑÂÄçÊï∞
                Object.entries(emojiCounts).forEach(([emoji, count]) => {
                    totalCards += count;
                    if (count % 3 !== 0) {
                        errors.push(`${emoji}: ${count}Âº† (‰∏çÊòØ3ÁöÑÂÄçÊï∞Ôºå‰ΩôÊï∞${count % 3})`);
                    } else {
                        validGroups += count / 3;
                    }
                });
                
                const isValid = errors.length === 0;
                
                return {
                    isValid,
                    errors,
                    totalCards,
                    totalEmojis: Object.keys(emojiCounts).length,
                    validGroups,
                    emojiCounts
                };
            }

            // Âº∫Âà∂‰øÆÂ§çÂç°ÁâåÁîüÊàê
            forceFixCardGeneration() {
                console.log('=== Âº∫Âà∂‰øÆÂ§çÂç°ÁâåÁîüÊàê ===');
                
                // ‰ΩøÁî®ÊúÄÁÆÄÂçïÂèØÈù†ÁöÑÊñπÊ≥ïÈáçÊñ∞ÁîüÊàê
                const levelConfig = this.levelConfigs[this.currentLevel - 1];
                const availableEmojis = this.emojis.slice(0, 6); // Âè™‰ΩøÁî®Ââç6ÁßçemojiÁ°Æ‰øùÂÆâÂÖ®
                
                // ËÆ°ÁÆóÂêàÁêÜÁöÑÂç°ÁâåÊÄªÊï∞ÔºàÁ°Æ‰øùÊòØ3ÁöÑÂÄçÊï∞Ôºâ
                const targetCards = Math.floor(this.cards.length / 3) * 3;
                const groupsNeeded = targetCards / 3;
                
                console.log(`ÁõÆÊ†áÂç°ÁâåÊï∞: ${targetCards} (${groupsNeeded}ÁªÑ)`);
                
                // Ê∏ÖÁ©∫Áé∞ÊúâÂç°Áâå
                this.cards = [];
                
                // ÈáçÊñ∞ÁîüÊàêÂç°ÁâåemojiÊï∞ÁªÑ
                const cardEmojis = [];
                
                // Âπ≥ÂùáÂàÜÈÖçÁªÑÊï∞Âà∞ÊØèÁßçemoji
                const groupsPerEmoji = Math.floor(groupsNeeded / availableEmojis.length);
                const remainingGroups = groupsNeeded % availableEmojis.length;
                
                availableEmojis.forEach((emoji, index) => {
                    const groupsForThisEmoji = groupsPerEmoji + (index < remainingGroups ? 1 : 0);
                    
                    for (let i = 0; i < groupsForThisEmoji; i++) {
                        for (let j = 0; j < 3; j++) {
                            cardEmojis.push(emoji);
                        }
                    }
                });
                
                // Êâì‰π±Êï∞ÁªÑ
                for (let i = cardEmojis.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [cardEmojis[i], cardEmojis[j]] = [cardEmojis[j], cardEmojis[i]];
                }
                
                // ÈáçÊñ∞ÁîüÊàêÂç°Áâå‰ΩçÁΩÆ
                let emojiIndex = 0;
                const layerSizes = [20, 25, 30, 35, 30, 25, 20]; // Âõ∫ÂÆöÁöÑÂ±ÇÁ∫ßÂàÜÂ∏É
                
                for (let layerIndex = layerSizes.length - 1; layerIndex >= 0; layerIndex--) {
                    const size = Math.min(layerSizes[layerIndex], cardEmojis.length - emojiIndex);
                    if (size <= 0) break;
                    
                    const positions = this.generateCompactPositions(size, layerIndex, layerSizes.length);
                    
                    positions.forEach(pos => {
                        if (emojiIndex < cardEmojis.length) {
                            const emoji = cardEmojis[emojiIndex++];
                            this.cards.push(new Card(pos.x, pos.y, layerIndex, emoji, {width: this.canvasDisplayWidth, height: this.canvasDisplayHeight}));
                        }
                    });
                }
                
                // ÊúÄÁªàÈ™åËØÅ
                const finalValidation = this.validateCardGeneration();
                if (finalValidation.isValid) {
                    console.log('‚úÖ Âº∫Âà∂‰øÆÂ§çÊàêÂäüÔºÅ');
                } else {
                    console.error('‚ùå Âº∫Âà∂‰øÆÂ§çÂ§±Ë¥•ÔºÅ', finalValidation.errors);
                }
            }

            initSlots() {
                const slotContainer = document.getElementById('slotContainer');
                slotContainer.innerHTML = '';
                for (let i = 0; i < this.maxSlots; i++) {
                    const slot = document.createElement('div');
                    slot.className = 'slot-card';
                    slot.id = `slot-${i}`;
                    slotContainer.appendChild(slot);
                }
            }

            createCards() {
                // Ëé∑ÂèñÂΩìÂâçÂÖ≥Âç°ÈÖçÁΩÆ
                const levelConfig = this.levelConfigs[this.currentLevel - 1];
                
                // ÊØèÂ±Ç‰ΩøÁî®ÈöèÊú∫Êï∞ÈáèÁöÑÂç°ÁâåÔºåÂü∫‰∫éÂÖ≥Âç°ÈÖçÁΩÆË∞ÉÊï¥
                let layerSizes = [];
                const baseMinCards = 20; // Âü∫Á°ÄÊØèÂ±ÇÊúÄÂ∞ëÂç°ÁâåÊï∞
                const baseMaxCards = 40; // Âü∫Á°ÄÊØèÂ±ÇÊúÄÂ§öÂç°ÁâåÊï∞
                
                for (let i = 0; i < 7; i++) {
                    // ÁîüÊàêÊØèÂ±ÇÁöÑÈöèÊú∫Âç°ÁâåÊï∞ÈáèÔºå‰∏≠Èó¥Â±ÇÊ¨°Â§ö‰∏Ä‰∫õ
                    let rangeMin, rangeMax;
                    if (i === 3) {
                        // ‰∏≠Èó¥Â±ÇÔºàÁ¨¨3Â±ÇÔºâÂç°ÁâåÊúÄÂ§ö
                        rangeMin = 35;
                        rangeMax = 45;
                    } else if (i === 2 || i === 4) {
                        // Ê¨°‰∏≠Èó¥Â±Ç
                        rangeMin = 30;
                        rangeMax = 40;
                    } else if (i === 1 || i === 5) {
                        // ËæπÁºòÂ±Ç
                        rangeMin = 25;
                        rangeMax = 35;
                    } else {
                        // ÊúÄÂ§ñÂ±Ç
                        rangeMin = baseMinCards;
                        rangeMax = 30;
                    }
                    
                    // Ê†πÊçÆÂÖ≥Âç°Ë∞ÉÊï¥Âç°ÁâåÊï∞Èáè
                    rangeMin = Math.floor(rangeMin * levelConfig.cardMultiplier);
                    rangeMax = Math.floor(rangeMax * levelConfig.cardMultiplier);
                    
                    const randomCount = Math.floor(Math.random() * (rangeMax - rangeMin + 1)) + rangeMin;
                    layerSizes.push(randomCount);
                }
                
                let totalCards = layerSizes.reduce((sum, size) => sum + size, 0);
                
                // Á°Æ‰øùÊÄªÂç°ÁâåÊï∞ÊòØ3ÁöÑÂÄçÊï∞ÔºåÈÅøÂÖçÂêéÁª≠ÁîüÊàêÈóÆÈ¢ò
                totalCards = Math.floor(totalCards / 3) * 3;
                
                // Ê†πÊçÆÂÖ≥Âç°ÈÄâÊã©emojiÁßçÁ±ª
                const availableEmojis = this.emojis.slice(0, levelConfig.emojiTypes);
                
                // ÁîüÊàêÁ°Æ‰øùÂèØÊ∂àÈô§ÁöÑÂç°ÁâåÊï∞ÁªÑÔºàÊñ∞ÁöÑ‰ºòÂåñÊñπÊ≥ïÔºâ
                const cardEmojis = this.generateSolvableCards(totalCards, availableEmojis, levelConfig);
                
                // Êõ¥Êñ∞ÊÄªÂç°ÁâåÊï∞Ôºà‰ΩøÁî®ÂÆûÈôÖÁîüÊàêÁöÑÊï∞ÈáèÔºâ
                const actualTotalCards = cardEmojis.length;
                
                // Ë∞ÉÊï¥layerSizes‰ª•ÂåπÈÖçcardEmojisÁöÑÈïøÂ∫¶
                if (totalCards !== actualTotalCards) {
                    console.log(`Ë∞ÉÊï¥layerSizes: ${totalCards} -> ${actualTotalCards}`);
                    
                    // ÊåâÊØî‰æãË∞ÉÊï¥Â±ÇÁ∫ßÂàÜÂ∏É
                    const originalTotal = totalCards;
                    const ratio = actualTotalCards / originalTotal;
                    
                    const newLayerSizes = [];
                    let remainingCards = actualTotalCards;
                    
                    for (let i = 0; i < layerSizes.length - 1; i++) {
                        const adjustedSize = Math.floor(layerSizes[i] * ratio);
                        newLayerSizes.push(adjustedSize);
                        remainingCards -= adjustedSize;
                    }
                    
                    // ÊúÄÂêé‰∏ÄÂ±ÇÂàÜÈÖçÊâÄÊúâÂâ©‰ΩôÂç°Áâå
                    newLayerSizes.push(Math.max(0, remainingCards));
                    
                    layerSizes = newLayerSizes;
                    console.log('Ë∞ÉÊï¥ÂêéÁöÑlayerSizes:', layerSizes);
                }
                
                let emojiIndex = 0;
                
                // ‰ªéÈ°∂Â±ÇÂºÄÂßãÁîüÊàêÔºàÁ¨¨6Â±ÇÂà∞Á¨¨0Â±ÇÔºâ
                for (let layerIndex = layerSizes.length - 1; layerIndex >= 0; layerIndex--) {
                    const size = layerSizes[layerIndex];
                    if (size <= 0) continue;
                    
                    console.log(`ÁîüÊàêÁ¨¨${layerIndex}Â±ÇÔºåÈúÄË¶Å${size}Âº†Âç°ÁâåÔºåÂΩìÂâçemojiIndex: ${emojiIndex}`);
                    
                    const positions = this.generateCompactPositions(size, layerIndex, layerSizes.length);
                    console.log(`Á¨¨${layerIndex}Â±ÇÁîüÊàê‰∫Ü${positions.length}‰∏™‰ΩçÁΩÆ`);
                    
                    if (positions.length !== size) {
                        console.warn(`Ë≠¶ÂëäÔºöÁ¨¨${layerIndex}Â±Ç‰ΩçÁΩÆÊï∞(${positions.length})‰∏éÈúÄÊ±Ç(${size})‰∏çÂåπÈÖç`);
                        // Â¶ÇÊûú‰ΩçÁΩÆÊï∞‰∏çÂåπÈÖçÔºå‰ΩøÁî®ÂÆûÈôÖÁîüÊàêÁöÑ‰ΩçÁΩÆÊï∞
                        console.log(`‰ΩøÁî®ÂÆûÈôÖ‰ΩçÁΩÆÊï∞: ${positions.length}`);
                    }
                    
                    // ‰ΩøÁî®ÂÆûÈôÖÁîüÊàêÁöÑ‰ΩçÁΩÆÊï∞ÔºåÈÅøÂÖçË∂äÁïå
                    const actualPositionsToUse = Math.min(positions.length, cardEmojis.length - emojiIndex);
                    console.log(`Á¨¨${layerIndex}Â±ÇÂÆûÈôÖ‰ΩøÁî®‰ΩçÁΩÆÊï∞: ${actualPositionsToUse}, Ââ©‰Ωôemoji: ${cardEmojis.length - emojiIndex}`);
                    
                    for (let i = 0; i < actualPositionsToUse; i++) {
                        const pos = positions[i];
                        if (emojiIndex < cardEmojis.length) {
                            const emoji = cardEmojis[emojiIndex];
                            this.cards.push(new Card(pos.x, pos.y, layerIndex, emoji, {width: this.canvasDisplayWidth, height: this.canvasDisplayHeight}));
                            emojiIndex++; // Âú®ÊàêÂäüÂàõÂª∫Âç°ÁâåÂêéÊâçÂ¢ûÂä†Á¥¢Âºï
                        } else {
                            console.error(`ÈîôËØØÔºöemojiIndex(${emojiIndex})Â∑≤ËææÂà∞ÊàñË∂ÖÂá∫cardEmojisÈïøÂ∫¶(${cardEmojis.length})ÔºåÂÅúÊ≠¢ÁîüÊàêÁ¨¨${layerIndex}Â±ÇÂâ©‰ΩôÂç°Áâå`);
                            break; // Ë∑≥Âá∫ÂΩìÂâçÂ±ÇÁöÑÂæ™ÁéØ
                        }
                    }
                    
                    // Â¶ÇÊûúemojiÂ∑≤ÁªèÁî®ÂÆåÔºåÂÅúÊ≠¢ÁîüÊàêÂêéÁª≠Â±Ç
                    if (emojiIndex >= cardEmojis.length) {
                        console.log(`ÊâÄÊúâemojiÂ∑≤ÂàÜÈÖçÂÆåÊØïÔºåÂÅúÊ≠¢ÁîüÊàêÂêéÁª≠Â±ÇÁ∫ß`);
                        break;
                    }
                }
                
                // È™åËØÅÊâÄÊúâÂç°ÁâåÈÉΩË¢´ÂàÜÈÖç
                console.log(`ÁîüÊàêÁöÑÂç°ÁâåÊÄªÊï∞: ${this.cards.length}`);
                console.log(`È¢ÑÊúüÂç°ÁâåÊÄªÊï∞: ${actualTotalCards}`);
                console.log(`‰ΩøÁî®ÁöÑemojiÊï∞Èáè: ${emojiIndex}`);
                console.log(`ÂèØÁî®emojiÊï∞Èáè: ${cardEmojis.length}`);
                
                if (this.cards.length !== actualTotalCards) {
                    console.error(`‰∏•ÈáçÈîôËØØÔºöÂÆûÈôÖÁîüÊàêÁöÑÂç°ÁâåÊï∞(${this.cards.length})‰∏çÁ≠â‰∫éÈ¢ÑÊúüÊï∞Èáè(${actualTotalCards})`);
                }
                
                if (emojiIndex !== cardEmojis.length) {
                    console.error(`‰∏•ÈáçÈîôËØØÔºö‰ΩøÁî®ÁöÑemojiÊï∞Èáè(${emojiIndex})‰∏çÁ≠â‰∫éÂèØÁî®Êï∞Èáè(${cardEmojis.length})`);
                }
                
                // ‰øùÊåÅÂ±ÇÁ∫ßÊéíÂ∫èÔºàÂÖàÁªòÂà∂‰ΩéÂ±ÇÁ∫ßÔºâ
                this.cards.sort((a, b) => a.layer - b.layer);
            }
            
            generateCompactPositions(cardCount, layer, totalLayers) {
                const positions = [];
                // Âä®ÊÄÅËÆ°ÁÆóÂç°ÁâåÂ∞∫ÂØ∏ - ‰ΩøÁî®ÊòæÁ§∫Â∞∫ÂØ∏ËøõË°åÂùêÊ†áËÆ°ÁÆó
                const canvasDisplayWidth = this.canvasDisplayWidth;
                const canvasDisplayHeight = this.canvasDisplayHeight;
                
                const baseSize = Math.min(canvasDisplayWidth / 18, canvasDisplayHeight / 12, 65);
                const cardWidth = Math.max(30, baseSize);
                const cardHeight = Math.max(30, baseSize);
                const cardSpacing = Math.max(1, cardWidth * 0.02); // Ê†πÊçÆÂç°ÁâåÂ§ßÂ∞èË∞ÉÊï¥Èó¥Ë∑ù
                
                // ËÆ°ÁÆócanvas‰∏≠ÂøÉÁÇπ - ‰ΩøÁî®ÊòæÁ§∫Â∞∫ÂØ∏ÔºåÊï¥‰ΩìÂêëÂè≥ÂÅèÁßª
                const rightOffset = canvasDisplayWidth * 0; // ÂêëÂè≥ÂÅèÁßª10%ÁöÑÂÆΩÂ∫¶
                const centerX = canvasDisplayWidth / 2 + rightOffset;
                const centerY = canvasDisplayHeight / 2;
                
                // Ê†πÊçÆÂ±ÇÁ∫ßËÆ°ÁÆóYÂùêÊ†áÔºåÂä®ÊÄÅË∞ÉÊï¥Èó¥Ë∑ùÂíåÂÅèÁßª
                const layerSpacing = Math.min(cardHeight * 0.85, canvasDisplayHeight / (totalLayers + 2)); // Âä®ÊÄÅË∞ÉÊï¥Â±ÇÁ∫ßÈó¥Ë∑ù
                const yOffset = -canvasDisplayHeight * 0.2; // Âä®ÊÄÅÂêë‰∏äÂÅèÁßª
                const yBase = centerY - (totalLayers - 1) * layerSpacing / 2 + layer * layerSpacing + yOffset;
                
                // ËÆ°ÁÆóÊØèË°åÊúÄÂ§öËÉΩÊîæÂ§öÂ∞ëÂº†Âç°ÁâåÔºàÁ¥ßÂáëÂ±Ö‰∏≠ÊéíÂàóÔºâ
                const cardsPerRow = Math.min(cardCount, 11); // Â¢ûÂä†ÊØèË°åÂç°ÁâåÊï∞
                const rows = Math.ceil(cardCount / cardsPerRow);
                
                // ÈÄÇÂ∫¶Ê®™ÂêëÂ±ÇÁ∫ßÈîôÂºÄÊïàÊûú
                const horizontalOffset = cardWidth * (layer % 2 === 0 ? 0.6 : -0.6); // ÂÅ∂Êï∞Â±ÇÂè≥ÁßªÔºåÂ•áÊï∞Â±ÇÂ∑¶ÁßªÔºåÂä®ÊÄÅË∞ÉÊï¥ÈîôÂºÄË∑ùÁ¶ª
                
                // Á®çÂæÆÂ¢ûÂä†Á´ñÂêëÂ±ÇÁ∫ßÈîôÂºÄÊïàÊûú
                const verticalOffset = cardHeight * (layer % 3 === 0 ? 0.8 : layer % 3 === 1 ? -0.4 : 0.4); // 3Â±Ç‰∏Ä‰∏™Âæ™ÁéØÔºåÂä®ÊÄÅË∞ÉÊï¥ÈîôÂºÄË∑ùÁ¶ª
                
                // Ê†πÊçÆÂ±ÇÁ∫ßË∞ÉÊï¥ÊØèË°åÁöÑÂ±Ö‰∏≠‰ΩçÁΩÆ
                const layerWidthRatio = this.getLayerWidthRatio(layer, totalLayers);
                const adjustedCardsPerRow = Math.max(1, Math.floor(cardsPerRow * layerWidthRatio));
                
                let totalCardsPlaced = 0;
                for (let row = 0; row < rows; row++) {
                    const cardsInThisRow = Math.min(adjustedCardsPerRow, cardCount - totalCardsPlaced);
                    if (cardsInThisRow <= 0) break;
                    
                    const rowWidth = cardsInThisRow * (cardWidth + cardSpacing) - cardSpacing;
                    
                    // ËÆ°ÁÆóËØ•Ë°åÁöÑËµ∑ÂßãXÂùêÊ†áÔºàÂ±Ö‰∏≠ + Ê®™ÂêëÂ±ÇÁ∫ßÈîôÂºÄ + ÂÆΩÂ∫¶ÊØî‰æãË∞ÉÊï¥Ôºâ
                    const rowStartX = centerX - rowWidth / 2 + horizontalOffset;
                    
                    for (let col = 0; col < cardsInThisRow; col++) {
                        // Á¥ßÂáëÊéíÂàóÔºåÊúÄÂ∞èÈó¥Ë∑ù + Á´ñÂêëÂ±ÇÁ∫ßÈîôÂºÄ
                        const x = rowStartX + col * (cardWidth + cardSpacing);
                        const y = yBase + row * (cardHeight + cardSpacing) + verticalOffset;
                        
                        positions.push({x, y});
                        totalCardsPlaced++;
                    }
                }
                
                // Á°Æ‰øùÁîüÊàê‰∫ÜË∂≥Â§üÁöÑ‰ΩçÁΩÆ
                if (positions.length !== cardCount) {
                    console.warn(`Á¨¨${layer}Â±ÇÔºöÈúÄË¶Å${cardCount}‰∏™‰ΩçÁΩÆÔºåÂÆûÈôÖÁîüÊàê${positions.length}‰∏™‰ΩçÁΩÆ`);
                    
                    // Â¶ÇÊûú‰ΩçÁΩÆ‰∏çÂ§üÔºåÈáçÊñ∞ËÆ°ÁÆóÊõ¥ÂêàÁêÜÁöÑÂ∏ÉÂ±Ä
                    const remaining = cardCount - positions.length;
                    console.log(`Á¨¨${layer}Â±ÇÔºöÈúÄË¶ÅË°•ÂÖÖ${remaining}‰∏™‰ΩçÁΩÆ`);
                    
                    // ÈáçÊñ∞ËÆ°ÁÆóË°åÊï∞ÂíåÊØèË°åÂç°ÁâåÊï∞ÔºåÁ°Æ‰øùÂ∏ÉÂ±ÄÊõ¥Á¥ßÂáë
                    const newCardsPerRow = Math.min(cardCount, Math.ceil(Math.sqrt(cardCount * 1.5))); // ÈÄÇ‰∏≠ÁöÑÊØèË°åÂç°ÁâåÊï∞
                    const newRows = Math.ceil(cardCount / newCardsPerRow);
                    
                    // Ê∏ÖÁ©∫ÂéüÊúâ‰ΩçÁΩÆÔºåÈáçÊñ∞ÁîüÊàêÊõ¥ÂêàÁêÜÁöÑÂ∏ÉÂ±Ä
                    positions.length = 0;
                    
                    for (let row = 0; row < newRows; row++) {
                        const cardsInThisRow = Math.min(newCardsPerRow, cardCount - row * newCardsPerRow);
                        const rowWidth = cardsInThisRow * (cardWidth + cardSpacing) - cardSpacing;
                        const rowStartX = centerX - rowWidth / 2 + horizontalOffset;
                        
                        for (let col = 0; col < cardsInThisRow; col++) {
                            const x = rowStartX + col * (cardWidth + cardSpacing);
                            const y = yBase + row * (cardHeight + cardSpacing) + verticalOffset;
                            positions.push({x, y});
                        }
                    }
                    
                    console.log(`Á¨¨${layer}Â±ÇÔºöÈáçÊñ∞Â∏ÉÂ±ÄÂêéÂÖ±${positions.length}‰∏™‰ΩçÁΩÆÔºå${newRows}Ë°åÔºåÊØèË°åÊúÄÂ§ö${newCardsPerRow}Âº†`);
                }
                
                return positions;
            }
            
            getLayerWidthRatio(layer, totalLayers) {
                // ÂèåÊºèÊñóÁªìÊûÑÁöÑÂÆΩÂ∫¶ÊØî‰æã (7Â±Ç)
                const ratios = [0.4, 0.6, 0.8, 1.0, 0.8, 0.6, 0.4]; // ‰ªéÂ∫ïÂ±ÇÂà∞È°∂Â±ÇÁöÑÂÆΩÂ∫¶ÊØî‰æã
                return ratios[layer] || 1.0;
            }

            relayoutCards() {
                // ÈáçÊñ∞ËÆ°ÁÆóÊâÄÊúâÂç°ÁâåÁöÑ‰ΩçÁΩÆÔºå‰øùÊåÅÂéüÊúâÁöÑÊ∏∏ÊàèÁä∂ÊÄÅ
                if (!this.cards || this.cards.length === 0) return;
                
                // ÊåâÂ±ÇÁ∫ßÈáçÊñ∞ÂàÜÁªÑÁé∞ÊúâÂç°Áâå
                const cardsByLayer = {};
                this.cards.forEach(card => {
                    if (!cardsByLayer[card.layer]) {
                        cardsByLayer[card.layer] = [];
                    }
                    cardsByLayer[card.layer].push(card);
                });
                
                // ‰∏∫ÊØè‰∏ÄÂ±ÇÈáçÊñ∞ËÆ°ÁÆó‰ΩçÁΩÆ
                Object.keys(cardsByLayer).forEach(layerIndex => {
                    const layerCards = cardsByLayer[layerIndex];
                    const layer = parseInt(layerIndex);
                    const totalLayers = Math.max(...Object.keys(cardsByLayer).map(l => parseInt(l))) + 1;
                    
                    // ÁîüÊàêÊñ∞‰ΩçÁΩÆ
                    const newPositions = this.generateCompactPositions(layerCards.length, layer, totalLayers);
                    
                    // Êõ¥Êñ∞Âç°Áâå‰ΩçÁΩÆÂíåÂ∞∫ÂØ∏
                    layerCards.forEach((card, index) => {
                        if (index < newPositions.length) {
                            card.x = newPositions[index].x;
                            card.y = newPositions[index].y;
                            
                            // ÈáçÊñ∞ËÆ°ÁÆóÂç°ÁâåÂ∞∫ÂØ∏
                            const baseSize = Math.min(this.canvasDisplayWidth / 18, this.canvasDisplayHeight / 12, 65);
                            card.width = Math.max(30, baseSize);
                            card.height = Math.max(30, baseSize);
                        }
                    });
                });
                
                // ÈáçÊñ∞ËÆ°ÁÆóÈÅÆÊå°Áä∂ÊÄÅ
                this.updateClickableStatus();
            }

            updateClickableStatus() {
                // ÈáçÁΩÆÊâÄÊúâÂç°ÁâåÁöÑÁä∂ÊÄÅ
                this.cards.forEach(card => {
                    card.isClickable = false;
                    card.isBlocked = false;
                });

                // ‰ªéÈ´òÂ±ÇÂà∞‰ΩéÂ±ÇÊ£ÄÊü•ÈÅÆÊå°ÂÖ≥Á≥ª
                for (let i = this.cards.length - 1; i >= 0; i--) {
                    const card = this.cards[i];
                    if (!card.visible) continue;

                    let isBlocked = false;
                    
                    // Ê£ÄÊü•ÊòØÂê¶Ë¢´‰∏äÂ±ÇÁöÑÂç°ÁâåÈÅÆÊå°
                    for (let j = i + 1; j < this.cards.length; j++) {
                        const upperCard = this.cards[j];
                        if (!upperCard.visible) continue;
                        
                        if (this.isCardBlocked(card, upperCard)) {
                            isBlocked = true;
                            break;
                        }
                    }

                    // ËÆæÁΩÆÈÅÆÊå°Áä∂ÊÄÅÂíåÁÇπÂáªÁä∂ÊÄÅ
                    card.isBlocked = isBlocked;
                    if (!isBlocked) {
                        card.isClickable = true;
                    }
                }
            }

            isCardBlocked(lowerCard, upperCard) {
                // Á≤æÁ°ÆÁöÑÂÉèÁ¥†Á∫ßÈÅÆÊå°Ê£ÄÊµãÔºöÊ£ÄÊü•‰∏§‰∏™Âç°ÁâåÊòØÂê¶ÊúâÈáçÂè†Âå∫Âüü
                const lowerLeft = lowerCard.x;
                const lowerRight = lowerCard.x + lowerCard.width;
                const lowerTop = lowerCard.y;
                const lowerBottom = lowerCard.y + lowerCard.height;
                
                const upperLeft = upperCard.x;
                const upperRight = upperCard.x + upperCard.width;
                const upperTop = upperCard.y;
                const upperBottom = upperCard.y + upperCard.height;
                
                // Ê£ÄÊü•ÊòØÂê¶ÊúâÈáçÂè†
                const horizontalOverlap = lowerLeft < upperRight && lowerRight > upperLeft;
                const verticalOverlap = lowerTop < upperBottom && lowerBottom > upperTop;
                
                // Â¶ÇÊûúÊúâ‰ªªÊÑèÈáçÂè†ÔºåÂàôËÆ§‰∏∫Ë¢´ÈÅÆÊå°
                return horizontalOverlap && verticalOverlap;
            }

            bindEvents() {
                this.canvas.addEventListener('click', (e) => {
                    const rect = this.canvas.getBoundingClientRect();
                    // ËÆ°ÁÆóÁõ∏ÂØπ‰∫écanvasÊòæÁ§∫Â∞∫ÂØ∏ÁöÑÂùêÊ†á
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    this.handleClick(x, y);
                });
            }

            handleClick(x, y) {
                // ‰ªéÈ´òÂ±ÇÂà∞‰ΩéÂ±ÇÊü•ÊâæÁÇπÂáªÁöÑÂç°Áâå
                for (let i = this.cards.length - 1; i >= 0; i--) {
                    const card = this.cards[i];
                    if (card.visible && card.isClickable && card.isPointInside(x, y)) {
                        this.removeCard(card);
                        break;
                    }
                }
            }

            removeCard(card) {
                // ‰ªéÊ∏∏ÊàèÂå∫ÂüüÁßªÈô§Âç°Áâå
                card.visible = false;
                
                // Ê∑ªÂä†Âà∞ÊßΩ‰Ωç
                this.addToSlot(card);
                
                // Êõ¥Êñ∞ÊâÄÊúâÂç°ÁâåÁöÑÂèØÁÇπÂáªÁä∂ÊÄÅ
                this.updateClickableStatus();
                this.draw();
                
                // Ê£ÄÊü•Ê∏∏ÊàèÊòØÂê¶ÁªìÊùü
                this.checkGameEnd();
            }

            addToSlot(card) {
                console.log(`Ê∑ªÂä†Âç°ÁâåÂà∞ÊßΩ‰Ωç: ${card.emoji}`);
                console.log(`ÊßΩ‰ΩçÊ∑ªÂä†ÂâçÁä∂ÊÄÅ: [${this.slots.map((c, idx) => `${idx}:${c.emoji}`).join(', ')}]`);
                
                // Ê£ÄÊü•ÊßΩ‰ΩçÊòØÂê¶Â∑≤Êª°ÔºåÂ¶ÇÊûúÊª°‰∫ÜÂàôÊ∏∏ÊàèÂ§±Ë¥•
                if (this.slots.length >= this.maxSlots) {
                    this.gameOver(true);
                    return;
                }

                // Êü•ÊâæÁõ∏ÂêåemojiÁöÑÂç°ÁâåÂú®ÊßΩ‰Ωç‰∏≠ÁöÑ‰ΩçÁΩÆ
                const sameEmojiIndex = this.slots.findIndex(slotCard => slotCard.emoji === card.emoji);
                
                let newCardIndex;
                if (sameEmojiIndex !== -1) {
                    // ÊâæÂà∞Áõ∏ÂêåemojiÁöÑÂç°ÁâåÔºåÊèíÂÖ•Âà∞ÂÖ∂ÊúÄÂêé‰∏ÄÂº†ÁöÑÂ∞æÈÉ®
                    let insertIndex = sameEmojiIndex;
                    for (let i = sameEmojiIndex; i < this.slots.length; i++) {
                        if (this.slots[i].emoji === card.emoji) {
                            insertIndex = i + 1;
                        } else {
                            break;
                        }
                    }
                    this.slots.splice(insertIndex, 0, card);
                    newCardIndex = insertIndex;
                } else {
                    // Ê≤°ÊúâÊâæÂà∞Áõ∏ÂêåemojiÁöÑÂç°ÁâåÔºåÊ∑ªÂä†Âà∞Êú´Â∞æ
                    this.slots.push(card);
                    newCardIndex = this.slots.length - 1;
                }
                
                // Êõ¥Êñ∞ÊßΩ‰ΩçÊòæÁ§∫ÔºåÂπ∂ÊåáÂÆöÊñ∞Âç°ÁâåÁöÑÁ¥¢ÂºïÁî®‰∫éÂä®Áîª
                this.updateSlotDisplay(newCardIndex);
                
                console.log(`ÊßΩ‰ΩçÊ∑ªÂä†ÂêéÁä∂ÊÄÅ: [${this.slots.map((c, idx) => `${idx}:${c.emoji}`).join(', ')}]`);
                
                // Ê£ÄÊü•ÊòØÂê¶Êúâ3Âº†Áõ∏ÂêåÁöÑÂç°Áâå
                this.checkSlotMatch();
                
                // Â¶ÇÊûúÊßΩ‰ΩçÂàöÂ•ΩËææÂà∞ÊúÄÂ§ßÂÄºÔºåÊ£ÄÊü•ÊòØÂê¶ÊúâÂèØÊ∂àÈô§ÁöÑÂç°Áâå
                if (this.slots.length >= this.maxSlots) {
                    // Ê£ÄÊü•ÂΩìÂâçÊßΩ‰Ωç‰∏≠ÊòØÂê¶ÊúâÂèØÊ∂àÈô§ÁöÑÁªÑÂêà
                    if (!this.hasSlotMatch()) {
                        this.gameOver(true);
                        return;
                    }
                }
            }

            updateSlotDisplay(newCardIndex = -1) {
                const slotContainer = document.getElementById('slotContainer');
                const slotElements = slotContainer.children;
                
                // Ê∏ÖÁ©∫ÊâÄÊúâÊßΩ‰Ωç
                for (let i = 0; i < slotElements.length; i++) {
                    const slot = slotElements[i];
                    slot.textContent = '';
                    slot.className = 'slot-card';
                }
                
                // Â°´ÂÖÖÊßΩ‰Ωç
                this.slots.forEach((card, index) => {
                    if (index < this.maxSlots) {
                        const slot = slotElements[index];
                        slot.textContent = card.emoji;
                        
                        // Âè™ÊúâÊñ∞Ê∑ªÂä†ÁöÑÂç°ÁâåÊâçÊí≠ÊîæÂä®Áîª
                        if (index === newCardIndex) {
                            slot.className = 'slot-card adding';
                            
                            // Ê∑ªÂä†ÂÆåÊàêÂä®ÁîªÂêéÁßªÈô§Âä®ÁîªÁ±ª
                            setTimeout(() => {
                                slot.classList.remove('adding');
                            }, 500);
                        } else {
                            slot.className = 'slot-card';
                        }
                    }
                });
                
                // Â¶ÇÊûúÊßΩ‰ΩçÊé•ËøëÊª°ÔºåÊ∑ªÂä†Ë≠¶ÂëäÊïàÊûú
                if (this.slots.length >= this.maxSlots - 1) {
                    for (let i = 0; i < slotElements.length; i++) {
                        if (i >= this.slots.length) {
                            slotElements[i].classList.add('warning');
                        }
                    }
                }
            }

            checkSlotMatch() {
                // Â¶ÇÊûúÊ≠£Âú®ÁßªÈô§‰∏≠ÔºåË∑≥ËøáÊ£ÄÊü•ÔºåÈò≤Ê≠¢Á´ûÊÄÅÊù°‰ª∂
                if (this.isRemoving) {
                    console.log('Ê≠£Âú®ÁßªÈô§‰∏≠ÔºåË∑≥ËøáÊßΩ‰ΩçÊ£ÄÊü•');
                    return;
                }
                
                // Ê£ÄÊü•ÊòØÂê¶Êúâ3Âº†ËøûÁª≠ÁöÑÁõ∏Âêåemoji
                for (let i = 0; i <= this.slots.length - 3; i++) {
                    if (this.slots[i].emoji === this.slots[i + 1].emoji && 
                        this.slots[i].emoji === this.slots[i + 2].emoji) {
                        console.log(`ÂèëÁé∞3Âº†ËøûÁª≠Áõ∏ÂêåÂç°Áâå: ${this.slots[i].emoji} at positions [${i}, ${i+1}, ${i+2}]`);
                        console.log(`ÊßΩ‰ΩçÊ∂àÈô§ÂâçÁä∂ÊÄÅ: [${this.slots.map((c, idx) => `${idx}:${c.emoji}`).join(', ')}]`);
                        this.removeSlotMatch(i, i + 1, i + 2);
                        return;
                    }
                }
            }

            removeSlotMatch(index1, index2, index3) {
                // ËÆæÁΩÆÁßªÈô§Ê†áÂøóÔºåÈò≤Ê≠¢ÈáçÂ§çË∞ÉÁî®
                this.isRemoving = true;
                
                const emoji = this.slots[index1].emoji;
                console.log(`ÂºÄÂßãÁßªÈô§ÊµÅÁ®ãÔºåËÆæÁΩÆisRemoving=true`);
                
                // Ê∑ªÂä†Ê∂àÈô§Âä®Áîª
                const slotContainer = document.getElementById('slotContainer');
                const slotElements = slotContainer.children;
                
                [index1, index2, index3].forEach(index => {
                    if (slotElements[index]) {
                        slotElements[index].classList.add('removing');
                    }
                });
                
                // Á≠âÂæÖÂä®ÁîªÂÆåÊàêÂêéÁßªÈô§Âç°Áâå
                setTimeout(() => {
                    // È™åËØÅÁ¥¢Âºï‰ªçÁÑ∂ÊúâÊïàÔºåÈò≤Ê≠¢Á´ûÊÄÅÊù°‰ª∂ÂØºËá¥ÁöÑÈîôËØØ
                    const validIndices = [index1, index2, index3].filter(index => 
                        index >= 0 && index < this.slots.length && this.slots[index] && this.slots[index].emoji === emoji
                    );
                    
                    if (validIndices.length !== 3) {
                        console.error(`ÈîôËØØÔºöÈ¢ÑÊúüÁßªÈô§3Âº†${emoji}Ôºå‰ΩÜÂè™ÊâæÂà∞${validIndices.length}Âº†ÊúâÊïàÂç°Áâå`);
                        console.error(`ÂéüÂßãÁ¥¢Âºï: [${index1}, ${index2}, ${index3}]`);
                        console.error(`ÊúâÊïàÁ¥¢Âºï: [${validIndices.join(', ')}]`);
                        console.error(`ÂΩìÂâçÊßΩ‰ΩçÁä∂ÊÄÅ: [${this.slots.map((c, idx) => `${idx}:${c.emoji}`).join(', ')}]`);
                        this.isRemoving = false; // ÈáçÁΩÆÊ†áÂøó
                        return;
                    }
                    
                    // Â∞ÜÊúâÊïàÁ¥¢ÂºïÊéíÂ∫èÔºå‰ªéÂ§ßÂà∞Â∞èÁßªÈô§ÔºåÈÅøÂÖçÁ¥¢ÂºïÂèòÂåñÂΩ±Âìç
                    const sortedIndices = validIndices.sort((a, b) => b - a);
                    console.log(`ÁßªÈô§ÊßΩ‰ΩçÂç°Áâå: ${emoji} at indices [${index1}, ${index2}, ${index3}] -> valid sorted [${sortedIndices.join(', ')}]`);
                    
                    // ÊåâÈôçÂ∫èÁßªÈô§ÔºåÁ°Æ‰øùÁ¥¢Âºï‰∏ç‰ºöÂõ†‰∏∫ÂâçÈù¢ÁöÑÁßªÈô§ËÄåÊîπÂèò
                    sortedIndices.forEach(index => {
                        console.log(`ÁßªÈô§ÊßΩ‰ΩçÁ¥¢Âºï ${index}: ${this.slots[index]?.emoji}`);
                        this.slots.splice(index, 1);
                    });
                    
                    // ÈáçÊñ∞Êõ¥Êñ∞ÊßΩ‰ΩçÊòæÁ§∫
                    this.updateSlotDisplay();
                    
                    console.log(`ÊßΩ‰ΩçÊ∂àÈô§ÂêéÁä∂ÊÄÅ: [${this.slots.map((c, idx) => `${idx}:${c.emoji}`).join(', ')}]`);
                    console.log(`Ê∂àÈô§ÂÆåÊàêÔºåÂâ©‰ΩôÊßΩ‰ΩçÊï∞: ${this.slots.length}`);
                    
                    // Ê∏ÖÈô§ÁßªÈô§Ê†áÂøó
                    this.isRemoving = false;
                    console.log(`ÁßªÈô§ÊµÅÁ®ãÂÆåÊàêÔºåËÆæÁΩÆisRemoving=false`);
                    
                    // ÁßªÈô§ÂÆåÊàêÂêéÔºåÂÜçÊ¨°Ê£ÄÊü•ÊòØÂê¶ÊúâÊñ∞ÁöÑÂåπÈÖçÔºàÈÄíÂΩíË∞ÉÁî®Ôºâ
                    this.checkSlotMatch();
                    
                    // Ê£ÄÊü•Ê∏∏ÊàèÊòØÂê¶ÁªìÊùü
                    this.checkGameEnd();
                }, 500);
            }

            gameOver(isLoss) {
                // Á¶ÅÁî®ÊâÄÊúâÂç°ÁâåÁöÑÁÇπÂáª
                this.cards.forEach(card => {
                    card.isClickable = false;
                });
                this.draw();

                if (isLoss) {
                    this.showModal('Ê∏∏ÊàèÂ§±Ë¥•', `Âà´ÁÅ∞ÂøÉÔºåÂú®Á¨¨${this.currentLevel}ÂÖ≥ÂÜçËØï‰∏ÄÊ¨°ÔºÅ`, false, false);
                }
            }

            checkGameEnd() {
                const visibleCards = this.cards.filter(card => card.visible);
                const clickableCards = visibleCards.filter(card => card.isClickable);

                // ËÉúÂà©Êù°‰ª∂
                if (visibleCards.length === 0 && this.slots.length === 0) {
                    if (this.currentLevel < this.maxLevel) {
                        this.showModal(`Á¨¨${this.currentLevel}ÂÖ≥ËÉúÂà©ÔºÅ`, 'Â§™Ê£í‰∫ÜÔºÅÂáÜÂ§áÊåëÊàò‰∏ã‰∏ÄÂÖ≥ÂêßÔºÅ', true, true);
                    } else {
                        this.showModal('ÊÅ≠ÂñúÈÄöÂÖ≥ÔºÅ', 'ÊÇ®Â∑≤ÂÆåÊàêÊâÄÊúâÂÖ≥Âç°ÔºåÁúüÂéâÂÆ≥ÔºÅ', false, true);
                    }
                    this.gameOver(false); // Ê∏∏ÊàèÁªìÊùü‰ΩÜÈùûÂ§±Ë¥•
                    return;
                }

                // Â§±Ë¥•Êù°‰ª∂ÔºöÊ≤°ÊúâÂèØÁÇπÂáªÁöÑÂç°ÁâåÔºåÂπ∂‰∏îÊßΩÈáå‰πüÊ≤°ÊúâÂèØÂêàÊàêÁöÑ
                if (clickableCards.length === 0 && this.slots.length > 0) {
                    const hasPotentialMatch = this.canMakeAnyMove();
                    if (!hasPotentialMatch) {
                        this.gameOver(true); // Ê∏∏ÊàèÂ§±Ë¥•
                    }
                }
            }

            // Ê£ÄÊü•ÊòØÂê¶ËøòÊúâ‰ªª‰ΩïÂèØË°åÁöÑÁßªÂä®ÔºàÂåÖÊã¨ÁÇπÂáªÊñ∞Âç°ÁâåÂΩ¢ÊàêÈÖçÂØπÔºâ
            canMakeAnyMove() {
                const clickableCards = this.cards.filter(card => card.visible && card.isClickable);
                const slotCounts = {};
                this.slots.forEach(card => {
                    slotCounts[card.emoji] = (slotCounts[card.emoji] || 0) + 1;
                });

                // Ê£ÄÊü•ÊòØÂê¶ÊúâÁõ¥Êé•ÂèØ‰ª•‰∏âËøûÁöÑ
                for (const emoji in slotCounts) {
                    if (slotCounts[emoji] >= 3) return true; // ËôΩÁÑ∂checkSlotMatch‰ºöÂ§ÑÁêÜÔºå‰ΩÜËøôÈáå‰πüÂà§Êñ≠
                }

                // Ê£ÄÊü•ÁÇπÂáª‰ªª‰Ωï‰∏Ä‰∏™ÂèØÁÇπÂáªÁöÑÂç°ÁâåÂêéÔºåÊòØÂê¶ËÉΩÂΩ¢Êàê‰∏âËøû
                for (const card of clickableCards) {
                    if ((slotCounts[card.emoji] || 0) === 2) {
                        return true; // ÁÇπÂáªËøôÂº†ÁâåÂèØ‰ª•ÂáëÊàê‰∏âËøû
                    }
                }

                // Ê£ÄÊü•ÊòØÂê¶ËøòÊúâË∂≥Â§üÁöÑÁ©∫ÊßΩ‰ΩçÂíåÂç°ÁâåÊù•ÂÆåÊàêÊ∏∏Êàè
                if (this.slots.length + clickableCards.length < 3) {
                     // Â¶ÇÊûúÊßΩ‰ΩçÂä†‰∏äÊâÄÊúâÂèØÁÇπÂáªÁöÑÁâåÈÉΩÂáë‰∏çÂ§ü3‰∏™ÔºåÈÇ£ËÇØÂÆöËæì‰∫Ü
                     if (this.cards.filter(c => c.visible).length > 0) return false;
                }

                return false;
            }

            hasSlotMatch() {
                // Ê£ÄÊü•ÊßΩ‰Ωç‰∏≠ÊòØÂê¶ÊúâÂèØÊ∂àÈô§ÁöÑ3Âº†Áõ∏ÂêåÂç°Áâå
                for (let i = 0; i <= this.slots.length - 3; i++) {
                    if (this.slots[i].emoji === this.slots[i + 1].emoji && 
                        this.slots[i].emoji === this.slots[i + 2].emoji) {
                        return true;
                    }
                }
                return false;
            }

            draw() {
                // ‰ΩøÁî®ÊòæÁ§∫Â∞∫ÂØ∏Êù•Ê∏ÖÈô§canvasÔºàÂùêÊ†áÁ≥ªÁªüÂü∫‰∫éÊòæÁ§∫Â∞∫ÂØ∏Ôºâ
                this.ctx.clearRect(0, 0, this.canvasDisplayWidth, this.canvasDisplayHeight);
                
                // ÁªòÂà∂ÊâÄÊúâÂèØËßÅÂç°Áâå
                this.cards.forEach(card => {
                    if (card.visible) {
                        card.draw(this.ctx);
                    }
                });
            }

            // ÈáçÊñ∞ÂºÄÂßãÊ∏∏Êàè
            restart() {
                // ÈáçÁΩÆÂà∞Á¨¨‰∏ÄÂÖ≥
                this.currentLevel = 1;
                document.getElementById('modalNextLevelBtn').style.display = 'none';
                
                // Ê∏ÖÁ©∫Ê∏∏ÊàèÁä∂ÊÄÅ
                this.cards = [];
                this.slots = [];
                this.isRemoving = false; // ÈáçÁΩÆÁßªÈô§Ê†áÂøó
                
                // Ê∏ÖÁ©∫ÊßΩ‰ΩçÊòæÁ§∫
                this.initSlots();
                
                // ÈáçÊñ∞ÂàùÂßãÂåñÊ∏∏Êàè
                this.init();
            }

            // ÁîüÊàêÁ°Æ‰øùÂèØÊ∂àÈô§ÁöÑÂç°ÁâåÊï∞ÁªÑÔºà‰ºòÂåñÁâàÊú¨Ôºâ
            generateSolvableCards(totalCards, availableEmojis, levelConfig) {
                console.log('=== ÂºÄÂßãÁîüÊàêÂèØÊ∂àÈô§ÁöÑÂç°ÁâåÊï∞ÁªÑ ===');
                
                // Á°Æ‰øùÊÄªÂç°ÁâåÊï∞ÊòØ3ÁöÑÂÄçÊï∞
                const adjustedTotalCards = Math.floor(totalCards / 3) * 3;
                const totalGroups = adjustedTotalCards / 3;
                
                console.log(`ÂéüÂßãÂç°ÁâåÊï∞: ${totalCards}, Ë∞ÉÊï¥Âêé: ${adjustedTotalCards}, ÈúÄË¶ÅÁîüÊàê${totalGroups}ÁªÑ`);
                
                // ÈôêÂà∂emojiÁßçÁ±ªÊï∞ÈáèÔºåÁ°Æ‰øùÂÆâÂÖ®
                const maxEmojiTypes = Math.min(levelConfig.emojiTypes, availableEmojis.length, 8);
                const safeEmojis = availableEmojis.slice(0, maxEmojiTypes);
                
                console.log(`‰ΩøÁî®${safeEmojis.length}Áßçemoji: ${safeEmojis.join(', ')}`);
                
                // Á°Æ‰øùËá≥Â∞ëÊúâË∂≥Â§üÁöÑemojiÁßçÁ±ªÊù•ÂàÜÈÖçÊâÄÊúâÁªÑ
                if (totalGroups < safeEmojis.length) {
                    // Â¶ÇÊûúÁªÑÊï∞Â∞ë‰∫éemojiÁßçÁ±ªÔºåÂàôÂè™‰ΩøÁî®ÂâçtotalGroupsÁßçemoji
                    const usedEmojis = safeEmojis.slice(0, totalGroups);
                    console.log(`ÁªÑÊï∞ËæÉÂ∞ëÔºåÂè™‰ΩøÁî®${usedEmojis.length}Áßçemoji`);
                
                const cardEmojis = [];
                    usedEmojis.forEach(emoji => {
                        // ÊØèÁßçemoji‰∏ÄÁªÑÔºà3Âº†Ôºâ
                        for (let i = 0; i < 3; i++) {
                            cardEmojis.push(emoji);
                        }
                    });
                    
                    // È™åËØÅÂπ∂ËøîÂõû
                    const validationResult = this.validateEmojiArray(cardEmojis);
                    if (validationResult.isValid) {
                        console.log('‚úÖ ÁÆÄÂçïÂàÜÈÖçÊàêÂäüÁîüÊàêÊúâÊïàÂç°ÁâåÊï∞ÁªÑ');
                        return this.shuffleArray(cardEmojis, levelConfig.shuffleRate);
                    }
                }
                
                // Ê≠£Â∏∏ÊÉÖÂÜµÔºöÂπ≥ÂùáÂàÜÈÖçÁªÑÊï∞Âà∞ÊØèÁßçemoji
                const cardEmojis = [];
                const groupsPerEmoji = Math.floor(totalGroups / safeEmojis.length);
                const remainingGroups = totalGroups % safeEmojis.length;
                
                console.log(`ÊØèÁßçemojiÂü∫Á°ÄÁªÑÊï∞: ${groupsPerEmoji}, Ââ©‰ΩôÁªÑÊï∞: ${remainingGroups}`);
                
                safeEmojis.forEach((emoji, index) => {
                    // ÂâçremainingGroupsÁßçemojiÂ§öÂàÜÈÖç‰∏ÄÁªÑ
                    const groupsForThisEmoji = groupsPerEmoji + (index < remainingGroups ? 1 : 0);
                    const cardsForThisEmoji = groupsForThisEmoji * 3;
                    
                    console.log(`${emoji}: ${groupsForThisEmoji}ÁªÑ (${cardsForThisEmoji}Âº†)`);
                    
                    // ‰∏∫ËøôÁßçemojiÊ∑ªÂä†ÊâÄÊúâÂç°Áâå
                    for (let i = 0; i < cardsForThisEmoji; i++) {
                            cardEmojis.push(emoji);
                        }
                });
                
                // È™åËØÅÁîüÊàêÁöÑÊï∞ÁªÑ
                console.log(`ÁîüÊàê‰∫Ü${cardEmojis.length}Âº†Âç°ÁâåÔºåÈ¢ÑÊúü${adjustedTotalCards}Âº†`);
                
                if (cardEmojis.length !== adjustedTotalCards) {
                    console.error(`‰∏•ÈáçÈîôËØØ: ÁîüÊàêÁöÑÂç°ÁâåÊï∞Èáè‰∏çÂåπÈÖç!`);
                    return this.generateEmergencyCards(adjustedTotalCards, safeEmojis);
                }
                
                // ÊúÄÁªàÈ™åËØÅ
                const validationResult = this.validateEmojiArray(cardEmojis);
                if (!validationResult.isValid) {
                    console.error('ÁîüÊàêÁöÑÂç°ÁâåÊï∞ÁªÑÈ™åËØÅÂ§±Ë¥•:', validationResult.errors);
                    return this.generateEmergencyCards(adjustedTotalCards, safeEmojis);
                }
                
                console.log('‚úÖ ÊàêÂäüÁîüÊàêÊúâÊïàÁöÑÂç°ÁâåÊï∞ÁªÑ');
                console.log('È™åËØÅÁªìÊûú:', validationResult);
                
                // Ê†πÊçÆÂÖ≥Âç°ÈöæÂ∫¶Êâì‰π±Êï∞ÁªÑ
                return this.shuffleArray(cardEmojis, levelConfig.shuffleRate);
                }
                
            // È™åËØÅemojiÊï∞ÁªÑÁöÑÊúâÊïàÊÄß
            validateEmojiArray(emojiArray) {
                const emojiCounts = {};
                emojiArray.forEach(emoji => {
                    emojiCounts[emoji] = (emojiCounts[emoji] || 0) + 1;
                });
                
                const errors = [];
                let validGroups = 0;
                
                Object.entries(emojiCounts).forEach(([emoji, count]) => {
                    if (count % 3 !== 0) {
                        errors.push(`${emoji}: ${count}Âº† (‰ΩôÊï∞${count % 3})`);
                    } else {
                        validGroups += count / 3;
                    }
                });
                
                return {
                    isValid: errors.length === 0,
                    errors,
                    totalCards: emojiArray.length,
                    totalEmojis: Object.keys(emojiCounts).length,
                    validGroups,
                    emojiCounts
                };
            }

            // Êô∫ËÉΩÊâì‰π±Êï∞ÁªÑ
            shuffleArray(array, shuffleRate) {
                const shuffledArray = [...array];
                const shuffleIterations = Math.max(1, Math.floor(array.length * shuffleRate));
                
                console.log(`Êâì‰π±${shuffleIterations}Ê¨°`);
                
                for (let iter = 0; iter < shuffleIterations; iter++) {
                    for (let i = shuffledArray.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [shuffledArray[i], shuffledArray[j]] = [shuffledArray[j], shuffledArray[i]];
                    }
                }
                
                return shuffledArray;
            }

            // ÁîüÊàêÁªùÂØπÂÆâÂÖ®ÁöÑÂç°ÁâåÊï∞ÁªÑÔºàÂ§áÁî®ÊñπÊ°àÔºâ
            generateSafeCards(totalCards, availableEmojis) {
                const cardEmojis = [];
                const groupsNeeded = Math.floor(totalCards / 3);
                
                // ‰ΩøÁî®Âæ™ÁéØÂàÜÈÖçÔºåÁ°Æ‰øùÊØèÁßçemojiÈÉΩÊúâÂÆåÊï¥ÁöÑ3ÂÄçÊï∞ÁªÑ
                for (let i = 0; i < groupsNeeded; i++) {
                    const emoji = availableEmojis[i % availableEmojis.length];
                    for (let j = 0; j < 3; j++) {
                        cardEmojis.push(emoji);
                    }
                }
                
                // Êâì‰π±Êï∞ÁªÑ
                for (let i = cardEmojis.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [cardEmojis[i], cardEmojis[j]] = [cardEmojis[j], cardEmojis[i]];
                }
                
                return cardEmojis;
            }

            // Á¥ßÊÄ•Â§áÁî®ÊñπÊ°àÔºöÊúÄÁÆÄÂçïÁöÑÁîüÊàêÊñπÊ≥ïÔºà‰ºòÂåñÁâàÔºâ
            generateEmergencyCards(totalCards, availableEmojis) {
                console.log('=== ‰ΩøÁî®Á¥ßÊÄ•Â§áÁî®ÊñπÊ°àÁîüÊàêÂç°Áâå ===');
                
                const adjustedTotalCards = Math.floor(totalCards / 3) * 3;
                const groupsNeeded = adjustedTotalCards / 3;
                
                // Âè™‰ΩøÁî®Ââç6ÁßçemojiÔºåÁ°Æ‰øùÁªùÂØπÂÆâÂÖ®
                const safeEmojis = availableEmojis.slice(0, Math.min(6, availableEmojis.length));
                
                console.log(`Á¥ßÊÄ•ÊñπÊ°à: ÁîüÊàê${groupsNeeded}ÁªÑÂç°ÁâåÔºå‰ΩøÁî®${safeEmojis.length}Áßçemoji`);
                console.log('‰ΩøÁî®ÁöÑemoji:', safeEmojis);
                
                const cardEmojis = [];
                
                // ÁÆÄÂçïÂæ™ÁéØÂàÜÈÖçÔºöÊØèÁßçemojiËΩÆÊµÅÂàÜÈÖçÔºåÁõ¥Âà∞ËææÂà∞ÊâÄÈúÄÁªÑÊï∞
                for (let group = 0; group < groupsNeeded; group++) {
                    const emoji = safeEmojis[group % safeEmojis.length];
                    // ‰∏∫ÂΩìÂâçÁªÑÊ∑ªÂä†3Âº†Áõ∏ÂêåÁöÑemoji
                    for (let i = 0; i < 3; i++) {
                            cardEmojis.push(emoji);
                        }
                    }
                
                console.log(`Á¥ßÊÄ•ÊñπÊ°àÁîüÊàê‰∫Ü${cardEmojis.length}Âº†Âç°Áâå`);
                
                // È™åËØÅÁîüÊàêÁöÑÊï∞ÁªÑ
                const validationResult = this.validateEmojiArray(cardEmojis);
                console.log('Á¥ßÊÄ•ÊñπÊ°àÈ™åËØÅÁªìÊûú:', validationResult);
                
                if (validationResult.isValid) {
                    console.log('‚úÖ Á¥ßÊÄ•Â§áÁî®ÊñπÊ°àÊàêÂäüÁîüÊàêÊúâÊïàÂç°ÁâåÊï∞ÁªÑ');
                    // ËΩªÂ∫¶Êâì‰π±ÔºåÈÅøÂÖçËøá‰∫éËßÑÂæã
                    return this.shuffleArray(cardEmojis, 0.3);
                } else {
                    console.error('‚ùå Á¥ßÊÄ•Â§áÁî®ÊñπÊ°àÈ™åËØÅÂ§±Ë¥•!', validationResult.errors);
                    // Â¶ÇÊûúËøûÁ¥ßÊÄ•ÊñπÊ°àÈÉΩÂ§±Ë¥•ÔºåÁîüÊàêÊúÄÂü∫Á°ÄÁöÑÂç°Áâå
                    return this.generateBasicCards(adjustedTotalCards, safeEmojis);
                }
            }

            // ÊúÄÂü∫Á°ÄÁöÑÂç°ÁâåÁîüÊàêÔºàÊúÄÂêéÁöÑ‰øùÈô©Ôºâ
            generateBasicCards(totalCards, availableEmojis) {
                console.log('=== ‰ΩøÁî®ÊúÄÂü∫Á°ÄÁöÑÂç°ÁâåÁîüÊàêÊñπÊ≥ï ===');
                
                const cardEmojis = [];
                const emoji = availableEmojis[0]; // Âè™‰ΩøÁî®Á¨¨‰∏ÄÁßçemoji
                
                // ÁîüÊàêtotalCardsÂº†Áõ∏ÂêåÁöÑemojiÂç°Áâå
                for (let i = 0; i < totalCards; i++) {
                    cardEmojis.push(emoji);
                }
                
                console.log(`Âü∫Á°ÄÊñπÊ°à: ÁîüÊàê${totalCards}Âº†${emoji}Âç°Áâå`);
                
                // È™åËØÅ
                const validationResult = this.validateEmojiArray(cardEmojis);
                if (validationResult.isValid) {
                    console.log('‚úÖ Âü∫Á°ÄÊñπÊ°àÈ™åËØÅÊàêÂäü');
                } else {
                    console.error('‚ùå ËøûÂü∫Á°ÄÊñπÊ°àÈÉΩÂ§±Ë¥•‰∫Ü!', validationResult.errors);
                }
                
                return cardEmojis;
            }

            // Âä®ÊÄÅ‰øÆÂ§çemojiÊï∞ÈáèÔºåÁ°Æ‰øùÊâÄÊúâÈÉΩÊòØ3ÁöÑÂÄçÊï∞
            fixEmojiCounts(cardEmojis, availableEmojis) {
                console.log('=== ÂºÄÂßãÂä®ÊÄÅ‰øÆÂ§çemojiÊï∞Èáè ===');
                
                // ÁªüËÆ°ÂΩìÂâçÊØèÁßçemojiÁöÑÊï∞Èáè
                const emojiCounts = {};
                cardEmojis.forEach(emoji => {
                    emojiCounts[emoji] = (emojiCounts[emoji] || 0) + 1;
                });
                
                console.log('‰øÆÂ§çÂâçÁöÑemojiÊï∞Èáè:', emojiCounts);
                
                // ËÆ°ÁÆóÈúÄË¶ÅË°•ÂÖÖÁöÑÂç°Áâå
                const cardsToAdd = [];
                let totalAdded = 0;
                
                Object.entries(emojiCounts).forEach(([emoji, count]) => {
                    const remainder = count % 3;
                    if (remainder !== 0) {
                        const needed = (3 - remainder) % 3; // ÈúÄË¶ÅË°•ÂÖÖÁöÑÊï∞Èáè
                        console.log(`${emoji}: ÂΩìÂâç${count}Âº†Ôºå‰ΩôÊï∞${remainder}ÔºåÈúÄË¶ÅË°•ÂÖÖ${needed}Âº†`);
                        
                        for (let i = 0; i < needed; i++) {
                            cardsToAdd.push(emoji);
                        }
                        totalAdded += needed;
                    }
                });
                
                if (totalAdded === 0) {
                    console.log('‚úÖ ÊâÄÊúâemojiÊï∞ÈáèÈÉΩÊòØ3ÁöÑÂÄçÊï∞ÔºåÊó†ÈúÄ‰øÆÂ§ç');
                    return cardEmojis;
                }
                
                console.log(`ÊÄªÂÖ±ÈúÄË¶ÅË°•ÂÖÖ${totalAdded}Âº†Âç°Áâå`);
                
                // Â∞ÜË°•ÂÖÖÁöÑÂç°ÁâåÊ∑ªÂä†Âà∞Êï∞ÁªÑ‰∏≠
                const fixedCardEmojis = [...cardEmojis, ...cardsToAdd];
                
                // È™åËØÅ‰øÆÂ§çÁªìÊûú
                const fixedCounts = {};
                fixedCardEmojis.forEach(emoji => {
                    fixedCounts[emoji] = (fixedCounts[emoji] || 0) + 1;
                });
                
                console.log('‰øÆÂ§çÂêéÁöÑemojiÊï∞Èáè:', fixedCounts);
                
                // Ê£ÄÊü•ÊòØÂê¶ÂÖ®ÈÉ®‰øÆÂ§çÊàêÂäü
                let allValid = true;
                Object.entries(fixedCounts).forEach(([emoji, count]) => {
                    if (count % 3 !== 0) {
                        allValid = false;
                        console.error(`‚ùå ‰øÆÂ§çÂ§±Ë¥•: ${emoji}‰ªçÊúâ${count}Âº†Ôºå‰∏çÊòØ3ÁöÑÂÄçÊï∞`);
                    } else {
                        console.log(`‚úÖ ‰øÆÂ§çÊàêÂäü: ${emoji}Áé∞Âú®Êúâ${count}Âº†`);
                    }
                });
                
                if (allValid) {
                    console.log(`‚úÖ Âä®ÊÄÅ‰øÆÂ§çÂÆåÊàêÔºÅÊÄªÂÖ±Ë°•ÂÖÖ‰∫Ü${totalAdded}Âº†Âç°Áâå`);
                } else {
                    console.error('‚ùå Âä®ÊÄÅ‰øÆÂ§çÂ§±Ë¥•ÔºÅ');
                }
                
                return fixedCardEmojis;
            }

            // Ë∞ÉËØïÊ£ÄÊµãÊ∏∏ÊàèÁä∂ÊÄÅ
            debugGameState() {
                console.log('=== Ê∏∏ÊàèÁä∂ÊÄÅË∞ÉËØïÊ£ÄÊµã ===');
                console.log(`ÂΩìÂâçÂÖ≥Âç°: ${this.currentLevel}`);
                console.log(`ÊÄªÂç°ÁâåÊï∞: ${this.cards.length}`);
                console.log(`ÊßΩ‰ΩçÂç°ÁâåÊï∞: ${this.slots.length}`);
                
                // Ëé∑ÂèñÂΩìÂâçÊ∏∏Êàè‰∏≠ÂÆûÈôÖÂ≠òÂú®ÁöÑÂç°ÁâåÔºöÂèØËßÅÁöÑÂç°Áâå + ÊßΩ‰Ωç‰∏≠ÁöÑÂç°Áâå
                const visibleCards = this.cards.filter(card => card.visible);
                const allActiveCards = [...visibleCards, ...this.slots];
                console.log(`ÂèØËßÅÂç°ÁâåÊï∞: ${visibleCards.length}`);
                console.log(`Ââ©‰ΩôÂç°ÁâåÊÄªÊï∞: ${allActiveCards.length}`);
                
                // ÁªüËÆ°ÊØèÁßçemojiÁöÑÊï∞ÈáèÔºàÂè™ÁªüËÆ°ÂΩìÂâçÊ∏∏Êàè‰∏≠Â≠òÂú®ÁöÑÔºâ
                const emojiCounts = {};
                allActiveCards.forEach(card => {
                    emojiCounts[card.emoji] = (emojiCounts[card.emoji] || 0) + 1;
                });
                
                console.log('=== EmojiÊï∞ÈáèÁªüËÆ° ===');
                Object.keys(emojiCounts).forEach(emoji => {
                    const count = emojiCounts[emoji];
                    const remainder = count % 3;
                    console.log(`${emoji}: ${count}Âº† (‰ΩôÊï∞: ${remainder})`);
                });
                
                // Ê£ÄÊµãÊòØÂê¶ÊâÄÊúâemojiÈÉΩËÉΩ3-3ÈÖçÂØπÁ©∑Â∞Ω
                const canComplete = this.checkGameCompletable(emojiCounts);
                console.log('=== ÈÖçÂØπÊ£ÄÊµãÁªìÊûú ===');
                console.log(`Ê∏∏ÊàèÊòØÂê¶ÂèØÂÆåÊàê: ${canComplete ? 'ÊòØ' : 'Âê¶'}`);
                
                if (!canComplete) {
                    console.log('‚ö†Ô∏è  Ë≠¶ÂëäÔºöÊ∏∏ÊàèÊó†Ê≥ïÂÆåÊàêÔºÅÂ≠òÂú®Êó†Ê≥ïÈÖçÂØπÁöÑemojiÔºÅ');
                    this.analyzeProblematicEmojis(emojiCounts);
                } else {
                    console.log('‚úÖ Ê∏∏ÊàèÂèØ‰ª•Ê≠£Â∏∏ÂÆåÊàêÔºåÊâÄÊúâemojiÈÉΩÂèØ‰ª•3-3ÈÖçÂØπÁ©∑Â∞Ω');
                }
                
                // ËØ¶ÁªÜÂàÜÊûêÈÖçÂØπÂèØËÉΩÊÄß
                this.analyzePairingPossibilities(emojiCounts);
                
                // ÊòæÁ§∫ÊßΩ‰Ωç‰∏≠ÁöÑÂç°Áâå
                console.log('=== ÊßΩ‰ΩçÁä∂ÊÄÅ ===');
                this.slots.forEach((card, index) => {
                    console.log(`ÊßΩ‰Ωç${index + 1}: ${card.emoji}`);
                });
                
                // ÊòæÁ§∫ÂèØÁÇπÂáªÁöÑÂç°ÁâåÊï∞ÈáèÂíåËØ¶ÊÉÖ
                const clickableCards = this.cards.filter(card => card.visible && card.isClickable);
                const blockedCards = this.cards.filter(card => card.visible && !card.isClickable);
                console.log(`ÂèØÁÇπÂáªÂç°ÁâåÊï∞: ${clickableCards.length}`);
                console.log(`Ë¢´ÈÅÆÊå°Âç°ÁâåÊï∞: ${blockedCards.length}`);
                
                // ÊòæÁ§∫Ââ©‰ΩôÂèØÁÇπÂáªÂç°ÁâåÁöÑËØ¶ÊÉÖ
                if (clickableCards.length > 0) {
                    console.log('=== Ââ©‰ΩôÂèØÁÇπÂáªÂç°ÁâåËØ¶ÊÉÖ ===');
                    clickableCards.forEach((card, index) => {
                        console.log(`ÂèØÁÇπÂáªÂç°Áâå${index + 1}: ${card.emoji} (Â±ÇÁ∫ß: ${card.layer}, ‰ΩçÁΩÆ: ${Math.round(card.x)}, ${Math.round(card.y)})`);
                    });
                }
                
                // Â¶ÇÊûúÊúâÂâ©‰ΩôÂç°Áâå‰ΩÜÊï∞Èáè‰∏çÊòØ3ÁöÑÂÄçÊï∞ÔºåÊòæÁ§∫Ë≠¶Âëä
                if (allActiveCards.length > 0 && !this.checkGameCompletable(emojiCounts)) {
                    console.log('‚ö†Ô∏è  Ë≠¶ÂëäÔºöÂΩìÂâçÂâ©‰ΩôÂç°ÁâåÊó†Ê≥ïÂÆåÊàê3-3ÈÖçÂØπÔºÅ');
                }
                
                console.log('=== Ê£ÄÊµãÂÆåÊàê ===');
            }

            // Ê£ÄÊü•Ê∏∏ÊàèÊòØÂê¶ÂèØÂÆåÊàê
            checkGameCompletable(emojiCounts) {
                // Ê£ÄÊü•ÊØèÁßçemojiÁöÑÊï∞ÈáèÊòØÂê¶ÈÉΩÊòØ3ÁöÑÂÄçÊï∞
                for (const emoji in emojiCounts) {
                    const count = emojiCounts[emoji];
                    if (count % 3 !== 0) {
                        return false;
                    }
                }
                return true;
            }

            // ÂàÜÊûêÊúâÈóÆÈ¢òÁöÑemoji
            analyzeProblematicEmojis(emojiCounts) {
                console.log('=== ÈóÆÈ¢òEmojiÂàÜÊûê ===');
                Object.keys(emojiCounts).forEach(emoji => {
                    const count = emojiCounts[emoji];
                    const remainder = count % 3;
                    if (remainder !== 0) {
                        console.log(`ÈóÆÈ¢òemoji ${emoji}: ${count}Âº†, ‰ΩôÊï∞${remainder}`);
                        if (remainder === 1) {
                            console.log(`  -> ÈúÄË¶Å${3 - remainder}Âº†ÊâçËÉΩÈÖçÂØπÔºå‰ΩÜÂè™Êúâ1Âº†ÔºåÊó†Ê≥ïÈÖçÂØπ`);
                        } else if (remainder === 2) {
                            console.log(`  -> ÈúÄË¶Å${3 - remainder}Âº†ÊâçËÉΩÈÖçÂØπÔºå‰ΩÜÂè™Êúâ2Âº†ÔºåÊó†Ê≥ïÈÖçÂØπ`);
                        }
                    }
                });
            }

            // ÂàÜÊûêÈÖçÂØπÂèØËÉΩÊÄß
            analyzePairingPossibilities(emojiCounts) {
                console.log('=== ÈÖçÂØπÂèØËÉΩÊÄßÂàÜÊûê ===');
                let totalPairs = 0;
                let remainingCards = 0;
                
                Object.keys(emojiCounts).forEach(emoji => {
                    const count = emojiCounts[emoji];
                    const pairs = Math.floor(count / 3);
                    const remainder = count % 3;
                    
                    console.log(`${emoji}: ÂèØÁªÑÊàê${pairs}ÁªÑ3Âº†ÈÖçÂØπÔºåÂâ©‰Ωô${remainder}Âº†`);
                    totalPairs += pairs;
                    remainingCards += remainder;
                });
                
                console.log(`ÊÄªËÆ°ÂèØÁªÑÊàê${totalPairs}ÁªÑ3Âº†ÈÖçÂØπ`);
                console.log(`ÊÄªËÆ°Ââ©‰Ωô${remainingCards}Âº†Êó†Ê≥ïÈÖçÂØπ`);
                
                if (remainingCards === 0) {
                    console.log('‚úÖ ÊâÄÊúâÂç°ÁâåÈÉΩÂèØ‰ª•ÂÆåÁæéÈÖçÂØπ');
                } else {
                    console.log(`‚ùå Êúâ${remainingCards}Âº†Âç°ÁâåÊó†Ê≥ïÈÖçÂØπ`);
                }
            }

            // Êõ¥Êñ∞ÂÖ≥Âç°ÊòæÁ§∫
            updateLevelDisplay() {
                const levelConfig = this.levelConfigs[this.currentLevel - 1];
                document.getElementById('currentLevel').textContent = this.currentLevel;
                document.getElementById('difficulty').textContent = levelConfig.name;
            }

            // ‰∏ã‰∏ÄÂÖ≥
            nextLevel() {
                if (this.currentLevel >= this.maxLevel) {
                    return;
                }

                this.currentLevel++;
                
                // Ê∏ÖÁ©∫Ê∏∏ÊàèÁä∂ÊÄÅ
                this.cards = [];
                this.slots = [];
                this.isRemoving = false; // ÈáçÁΩÆÁßªÈô§Ê†áÂøó
                
                // Ê∏ÖÁ©∫ÊßΩ‰ΩçÊòæÁ§∫
                this.initSlots();
                
                // ÈáçÊñ∞ÂàùÂßãÂåñÊ∏∏Êàè
                this.init();

            }

            showModal(title, message, showNextLevelButton, isWin) {
                const modal = document.getElementById('modal');
                document.getElementById('modalTitle').textContent = title;
                document.getElementById('modalMessage').textContent = message;

                const modalNextLevelBtn = document.getElementById('modalNextLevelBtn');
                const modalRestartBtn = document.getElementById('modalRestartBtn');

                if (showNextLevelButton) {
                    modalNextLevelBtn.style.display = 'inline-block';
                    modalRestartBtn.style.display = 'none';
                } else {
                    modalNextLevelBtn.style.display = 'none';
                    modalRestartBtn.style.display = 'inline-block';
                }
                
                if (isWin && this.currentLevel >= this.maxLevel) {
                    modalNextLevelBtn.style.display = 'none';
                    modalRestartBtn.style.display = 'inline-block';
                }

                modal.style.display = 'flex';

                if (!this.modalListenersAdded) {
                    modalNextLevelBtn.onclick = () => {
                        this.hideModal();
                        this.nextLevel();
                    };
                    modalRestartBtn.onclick = () => {
                        this.hideModal();
                        this.restart();
                    };
                    this.modalListenersAdded = true;
                }
            }

            hideModal() {
                document.getElementById('modal').style.display = 'none';
            }
        }

        // ÂêØÂä®Ê∏∏Êàè
        window.addEventListener('load', () => {
            const canvas = document.getElementById('gameCanvas');
            window.game = new Game(canvas);
        });
    </script>
</body>
</html>